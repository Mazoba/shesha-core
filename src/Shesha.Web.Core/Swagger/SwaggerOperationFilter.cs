using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Reflection;
using System.Threading.Tasks;
using Abp.AspNetCore.Configuration;
using Abp.AspNetCore.Mvc.ExceptionHandling;
using Abp.AspNetCore.Mvc.Results;
using Abp.Web.Models;
using Microsoft.OpenApi.Models;
using Shesha.Reflection;
using Swashbuckle.AspNetCore.SwaggerGen;

namespace Shesha.Swagger
{
    public class SwaggerOperationFilter : IOperationFilter
    {
        private readonly IAbpAspNetCoreConfiguration _configuration;

        public SwaggerOperationFilter(IAbpAspNetCoreConfiguration configuration)
        {
            _configuration = configuration;
        }

        public void Apply(OpenApiOperation operation, OperationFilterContext context)
        {
            var wrapResultAttribute =
                GetSingleAttributeOfMemberOrDeclaringTypeOrDefault(
                    context.MethodInfo,
                    _configuration.DefaultWrapResultAttribute
                );

            if (wrapResultAttribute == null) // shouldn't be null, but we'll check
                return;

            var unwrappedReturnType = context.MethodInfo.ReturnType == typeof(Task)
                ? typeof(AjaxResponseBase)
                : context.MethodInfo.ReturnType.IsSubtypeOfGeneric(typeof(Task<>))
                    ? context.MethodInfo.ReturnType.GenericTypeArguments.FirstOrDefault()
                    : context.MethodInfo.ReturnType;

            var okResponse = ((int)HttpStatusCode.OK).ToString();
            if (wrapResultAttribute.WrapOnSuccess &&  // auto-wrapping of success response is enable
                                                      //!operation.Responses.ContainsKey(okResponse) && // OK response is missing
                unwrappedReturnType != typeof(AjaxResponseBase) // not added manually as AjaxResponseBase
                )
            {
                var wrappedResponseType = typeof(AjaxResponse<>).MakeGenericType(unwrappedReturnType);

                if (operation.Responses.ContainsKey(okResponse))
                    operation.Responses.Remove(okResponse);

                var schema = context.SchemaGenerator.GenerateSchema(wrappedResponseType, context.SchemaRepository);
                //schema.Reference.Id = unwrappedReturnType.Name; // use not wrapped class name
                //schema.Reference.Id = schema.Reference.Id.RemovePostfix(nameof(AjaxResponse));
                operation.Responses.Add(okResponse, new OpenApiResponse()
                {
                    Description = $"Wrapped with {nameof(AjaxResponse)}<> by {nameof(AbpResultFilter)}",
                    Content = new Dictionary<string, OpenApiMediaType>
                    {
                        ["application/json"] = new OpenApiMediaType
                        {
                            Schema = schema
                        }
                    }
                });
            }

            var badResponse = ((int)HttpStatusCode.BadRequest).ToString();
            if (wrapResultAttribute.WrapOnError && // auto-wrapping of error response is enable
                !operation.Responses.ContainsKey(badResponse) && // BadRequest response is missing
                unwrappedReturnType != typeof(AjaxResponseBase) // not added manually as AjaxResponseBase
                )
            {
                var responseType = typeof(AjaxResponseBase);

                if (operation.Responses.ContainsKey(badResponse))
                    operation.Responses.Remove(badResponse);

                var schema = context.SchemaGenerator.GenerateSchema(responseType, context.SchemaRepository);
                operation.Responses.Add(badResponse, new OpenApiResponse()
                {
                    Description = $"Generated by {nameof(AbpExceptionFilter)}",
                    Content = new Dictionary<string, OpenApiMediaType>
                    {
                        ["application/json"] = new OpenApiMediaType
                        {
                            Schema = schema
                        }
                    }
                });
            }
        }

        /// <summary>
        /// Copied from ABP
        /// Tries to gets an of attribute defined for a class member and it's declaring type including inherited attributes.
        /// Returns default value if it's not declared at all.
        /// </summary>
        /// <typeparam name="TAttribute">Type of the attribute</typeparam>
        /// <param name="memberInfo">MemberInfo</param>
        /// <param name="defaultValue">Default value (null as default)</param>
        /// <param name="inherit">Inherit attribute from base classes</param>
        public static TAttribute GetSingleAttributeOfMemberOrDeclaringTypeOrDefault<TAttribute>(MemberInfo memberInfo, TAttribute defaultValue = default(TAttribute), bool inherit = true)
            where TAttribute : class
        {
            return memberInfo.GetCustomAttributes(true).OfType<TAttribute>().FirstOrDefault()
                   ?? memberInfo.ReflectedType?.GetTypeInfo().GetCustomAttributes(true).OfType<TAttribute>().FirstOrDefault()
                   ?? defaultValue;
        }
    }
}
